<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --teal: #00695c; --orange: #ff9800; --soft-bg: #f4f7f6; }
        body { background: var(--soft-bg); font-family: 'Inter', sans-serif; color: #333; }
        
        .card-custom { background: white; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); border: none; overflow: hidden; }
        .login-card { max-width: 900px; margin: 60px auto; display: flex; flex-wrap: wrap; }
        .login-left { padding: 60px; flex: 1.2; border-right: 1px solid #eee; }
        .login-right { padding: 60px; flex: 1; background: #fafafa; display: flex; flex-direction: column; justify-content: center; }
        
        .wizard-step { display: none; max-width: 850px; margin: 20px auto; padding: 40px; }
        .active { display: block; animation: slideUp 0.4s ease; }
        
        .profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #8bc34a; object-fit: cover; }
        .btn-main { background: var(--orange); color: white; border-radius: 15px; padding: 12px; font-weight: 700; border: none; width: 100%; transition: 0.3s; }
        .btn-main:hover { background: #e68a00; transform: translateY(-2px); }
        
        .table-history { font-size: 0.8rem; border-radius: 15px; overflow: hidden; }
        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .no-print { display: none !important; } body { background: white; } .wizard-step { box-shadow: none; padding: 0; } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-success"></div><p class="mt-2 fw-bold">Memproses Data...</p></div>

<div class="container">
    <div id="stepLogin" class="card-custom login-card active">
        <div class="login-left">
            <div class="d-flex align-items-center mb-4">
                <img src="FotoProfil.jpg" class="profile-img me-3" onerror="this.src='https://via.placeholder.com/150'">
                <div><h5 class="fw-bold mb-0">Dian Agnesia</h5><p class="text-muted small mb-0">Lecturer of Nutrition</p></div>
            </div>
            <h1 class="fw-bold" style="font-size: 2.8rem;">NCP <span style="color:var(--orange)">of DA</span></h1>
            <p class="text-muted">Manajemen asuhan gizi terintegrasi dengan riwayat kunjungan.</p>
        </div>
        <div class="login-right">
            <input type="text" id="user" class="form-control mb-3 rounded-pill px-4" placeholder="Username">
            <input type="password" id="pass" class="form-control mb-4 rounded-pill px-4" placeholder="Password">
            <button onclick="doLogin()" class="btn-main shadow-sm">SIGN IN</button>
        </div>
    </div>

    <div id="stepPasien" class="card-custom wizard-step">
        <h4 class="fw-bold text-teal mb-4"><i class="bi bi-person-vcard"></i> Identitas Pasien</h4>
        <div class="mb-3">
            <label class="small fw-bold">Nama Lengkap Pasien</label>
            <input type="text" id="namaP" class="form-control form-control-lg bg-light border-0" placeholder="Masukkan nama untuk cek history">
        </div>
        <div class="row g-3 mb-4">
            <div class="col-md-6"><label class="small fw-bold">Tanggal Lahir</label><input type="date" id="tglP" class="form-control border-0 bg-light"></div>
            <div class="col-md-6"><label class="small fw-bold">Jenis Kelamin</label><select id="jkP" class="form-select border-0 bg-light"><option>Laki-laki</option><option>Perempuan</option></select></div>
        </div>
        <label class="small fw-bold">Diagnosa Medis</label>
        <textarea id="diagP" class="form-control border-0 bg-light mb-4" rows="2"></textarea>
        <button onclick="checkPatientHistory()" class="btn-main">PROSES ASESMEN</button>
    </div>

    <div id="stepAssess" class="card-custom wizard-step">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-teal mb-0">Nutrition Assessment</h4>
            <span id="badgeVisit" class="badge bg-success rounded-pill px-3">Kunjungan Baru</span>
        </div>

        <div id="areaHistory" class="mb-4 p-3 border rounded-4 bg-light" style="display:none;">
            <p class="small fw-bold text-primary mb-2"><i class="bi bi-clock-history"></i> Rekam Medis Sebelumnya:</p>
            <table class="table table-sm table-history bg-white">
                <thead class="table-dark"><tr><th>Tgl</th><th>Ke-</th><th>BB</th><th>IMT</th><th>PES</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>

        <div class="row g-3">
            <div class="col-6"><label class="small fw-bold">BB (kg)</label><input type="number" id="inBB" class="form-control"></div>
            <div class="col-6"><label class="small fw-bold">TB (cm)</label><input type="number" id="inTB" class="form-control"></div>
            <div class="col-12"><label class="small fw-bold text-muted text-uppercase mt-2">Data Biokimia</label><div id="labBox" class="row row-cols-2 g-2"></div></div>
            <div class="col-12 mt-3">
                <label class="small fw-bold">Asupan Makan: <span id="txtAsup">100</span>%</label>
                <input type="range" id="inAsup" class="form-range" min="0" max="150" value="100" oninput="document.getElementById('txtAsup').innerText=this.value">
            </div>
            <div id="fisikBox" class="row mt-2 gx-2 small"></div>
        </div>
        <button onclick="generatePES()" class="btn btn-success w-100 mt-5 py-3 rounded-pill fw-bold">SIMPAN & ANALISA PES</button>
    </div>

    <div id="stepHasil" class="card-custom wizard-step">
        <div id="printArea">
            <center><h5 class="fw-bold">NUTRITION CARE PROCESS REPORT</h5><p id="printVisit" class="small text-teal fw-bold"></p></center>
            <hr>
            <div id="printIdentitas" class="p-3 bg-light rounded-4 mb-3 small"></div>
            <div id="printPES"></div>
            <div class="row mt-5 small">
                <div class="col-6">Dicetak oleh: <br><b id="printAhliGizi"></b></div>
                <div class="col-6 text-end">Tanda tangan Ahli Gizi,<br><br><br><b>( ________________ )</b></div>
            </div>
        </div>
        <button onclick="finalPrint()" class="btn btn-primary w-100 mt-4 rounded-pill py-2 fw-bold no-print"><i class="bi bi-printer"></i> CETAK PDF</button>
        <button onclick="location.reload()" class="btn btn-link w-100 text-muted no-print text-decoration-none mt-2">Input Pasien Baru</button>
    </div>
</div>

<script>
    let DB = {}, userActive = "", visitNum = 1;

    function toggleLoad(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function show(id) { document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active')); document.getElementById('stepLogin').classList.remove('active'); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }

    // LOGIN & LOAD DB
    function doLogin() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        toggleLoad(true);
        google.script.run.withSuccessHandler(res => {
            DB = res;
            const valid = DB.user_access.find(x => x.username == u && x.password == p);
            if(valid) {
                userActive = valid.nama_lengkap;
                renderDynamicFields();
                show('stepPasien');
            } else { alert("User/Password salah!"); }
            toggleLoad(false);
        }).getFullDatabase();
    }

    // RENDER BIOKIMIA & FISIK DARI SPREADSHEET
    function renderDynamicFields() {
        let labH = "";
        DB.logika_biokimia.forEach(b => {
            labH += `<div class="col"><div class="p-2 border rounded bg-white"><label style="font-size:9px" class="fw-bold d-block text-muted text-uppercase">${b.Parameter}</label><input type="number" class="form-control form-control-sm border-0 p-0 in-lab" data-param="${b.Parameter}"></div></div>`;
        });
        document.getElementById('labBox').innerHTML = labH;

        let fisH = "";
        DB.logika_fisik_klinis.forEach((f, i) => {
            fisH += `<div class="col-6 mb-1"><div class="form-check"><input class="form-check-input chk-fisik" type="checkbox" value="${f.Gejala}" id="f${i}"><label class="form-check-label" for="f${i}">${f.Gejala}</label></div></div>`;
        });
        document.getElementById('fisikBox').innerHTML = fisH;
    }

    // CEK RIWAYAT PASIEN
    function checkPatientHistory() {
        const nama = document.getElementById('namaP').value;
        if(!nama) return alert("Masukkan nama!");
        toggleLoad(true);
        google.script.run.withSuccessHandler(history => {
            visitNum = history.length + 1;
            document.getElementById('badgeVisit').innerText = `Pemeriksaan Ke-${visitNum}`;
            document.getElementById('printVisit').innerText = `Pemeriksaan Ke-${visitNum}`;
            
            if(history.length > 0) {
                let rows = "";
                history.forEach(h => {
                    rows += `<tr><td>${h.Tanggal_Periksa}</td><td>${h.Kunjungan_Ke}</td><td>${h.BB_kg}</td><td>${h.IMT}</td><td>${h.Kode_PES}</td></tr>`;
                });
                document.getElementById('histBody').innerHTML = rows;
                document.getElementById('areaHistory').style.display = "block";
            } else {
                document.getElementById('areaHistory').style.display = "none";
            }
            show('stepAssess');
            toggleLoad(false);
        }).getPatientHistory(nama);
    }

    // LOGIKA DIAGNOSA & SIMPAN
    function generatePES() {
        const bb = parseFloat(document.getElementById('inBB').value), tb = parseFloat(document.getElementById('inTB').value)/100;
        const imt = bb / (tb * tb), asup = parseFloat(document.getElementById('inAsup').value);
        let codes = [];

        // 1. Antropometri
        DB.logika_antropometri.forEach(r => {
            if(imt >= r.Ambang_Bawah && imt <= r.Ambang_Atas) codes.push(r.Kode_Diagnosa);
        });
        // 2. Fisik
        document.querySelectorAll('.chk-fisik:checked').forEach(c => {
            const f = DB.logika_fisik_klinis.find(x => x.Gejala == c.value);
            if(f) codes.push(f.Kode_Diagnosa);
        });

        const uniqueCodes = [...new Set(codes)];
        renderPrint(imt, uniqueCodes);
    }

    function renderPrint(imt, codes) {
        document.getElementById('printAhliGizi').innerText = userActive;
        document.getElementById('printIdentitas').innerHTML = `<b>Nama:</b> ${document.getElementById('namaP').value} | <b>IMT:</b> ${imt.toFixed(1)} | <b>Asupan:</b> ${document.getElementById('inAsup').value}%`;
        
        let h = "", codesText = "";
        codes.forEach(c => {
            const m = DB.master_diagnosa_pes.find(x => x.Kode == c);
            if(m) {
                h += `<div class="p-3 border-start border-4 border-success bg-light mb-2 small shadow-sm"><b>${m.Kode}: ${m['Problem (P)']}</b><p class="mb-0 mt-1">E: ${m['Etiologi (E)']} | S: ${m['Signs_Symptoms (S)']}</p></div>`;
                codesText += c + ", ";
            }
        });
        document.getElementById('printPES').innerHTML = h || "Hasil Normal.";

        // Kirim ke Server untuk simpan history
        const payload = {
            Nama_Pasien: document.getElementById('namaP').value,
            Kunjungan_Ke: visitNum,
            Diagnosa_Medis: document.getElementById('diagP').value,
            BB_kg: document.getElementById('inBB').value,
            TB_cm: document.getElementById('inTB').value,
            IMT: imt.toFixed(1),
            Asupan_Energi: document.getElementById('inAsup').value,
            Data_Biokimia: "", 
            Fisik_Klinis: "",
            Kode_PES: codesText,
            Ahli_Gizi: userActive
        };
        google.script.run.saveAssessment(payload);
        show('stepHasil');
    }

    function finalPrint() {
        const nama = document.getElementById('namaP').value || "Pasien";
        document.title = `NCPofDA_${nama}`;
        window.print();
    }
</script>
</body>
</html>
