<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .card-box { max-width: 500px; margin: 50px auto; background: white; padding: 40px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .step { display: none; }
        .active { display: block; animation: fadeIn 0.4s; }
        #loader { display:none; position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:1000; justify-content:center; align-items:center; flex-direction:column; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary"></div><p class="mt-2">Memuat Data...</p></div>

<div class="container">
    <div id="step1" class="card-box active">
        <h3 class="fw-bold text-center text-primary mb-4">NCP of DA</h3>
        <input type="text" id="user" class="form-control mb-3 rounded-pill px-4" placeholder="Username">
        <input type="password" id="pass" class="form-control mb-4 rounded-pill px-4" placeholder="Password">
        <button onclick="doLogin()" class="btn btn-primary w-100 rounded-pill py-2 fw-bold">SIGN IN</button>
    </div>

    <div id="step2" class="card-box step">
        <h4 class="fw-bold mb-4 text-success">Identitas Pasien</h4>
        <input type="text" id="namaP" class="form-control mb-3" placeholder="Nama Lengkap Pasien">
        <button onclick="goAssess()" class="btn btn-success w-100 rounded-pill">LANJUTKAN</button>
    </div>

    <div id="step3" class="card-box step" style="max-width: 700px;">
        <h4 class="fw-bold text-primary mb-4">Assessment</h4>
        <div class="row g-3">
            <div class="col-6"><label class="small fw-bold">BB (kg)</label><input type="number" id="inBB" class="form-control"></div>
            <div class="col-6"><label class="small fw-bold">TB (cm)</label><input type="number" id="inTB" class="form-control"></div>
        </div>
        <button onclick="finalSimpan()" class="btn btn-danger w-100 mt-4 rounded-pill">SIMPAN & SELESAI</button>
    </div>
</div>

<script>
    let DB = {}, userActive = "", kunjunganKe = 1;

    function loading(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function show(id) { 
        document.querySelectorAll('.card-box, .step').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active'); 
    }

    function doLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(!u || !p) return alert("Isi username & password!");

        loading(true);
        google.script.run
            .withSuccessHandler(res => {
                DB = res;
                // Pastikan nama sheet adalah user_access (kecil semua, pakai underscore)
                const user = DB.user_access.find(x => x.username == u && x.password == p);
                if(user) {
                    userActive = user.nama_lengkap;
                    show('step2');
                } else {
                    alert("Login Gagal: Username atau Password salah.");
                }
                loading(false);
            })
            .withFailureHandler(err => {
                loading(false);
                alert("Error Sistem: " + err.message);
            })
            .getFullDatabase();
    }

    function goAssess() {
        const nama = document.getElementById('namaP').value;
        if(!nama) return alert("Isi nama pasien!");
        
        // Cek history kunjungan
        const hist = DB.History_Assessment.filter(x => x.Nama_Pasien.toString().toLowerCase() === nama.toLowerCase());
        kunjunganKe = hist.length + 1;
        
        show('step3');
    }

    function finalSimpan() {
        const bb = parseFloat(document.getElementById('inBB').value);
        const tb = parseFloat(document.getElementById('inTB').value) / 100;
        const imt = (bb / (tb * tb)).toFixed(1);

        const payload = {
            Nama_Pasien: document.getElementById('namaP').value,
            Kunjungan_Ke: kunjunganKe,
            BB_kg: bb,
            TB_cm: document.getElementById('inTB').value,
            IMT: imt,
            Asupan: 100,
            Ahli_Gizi: userActive,
            Kode_PES: "Dihitung Otomatis"
        };

        loading(true);
        google.script.run.withSuccessHandler(() => {
            alert("Data Berhasil Disimpan!");
            location.reload();
        }).saveAssessment(payload);
    }
</script>
</body>
</html>
