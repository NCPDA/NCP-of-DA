<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCP of DA - Professional Expert System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --teal: #00897b; --orange: #ff9800; --light: #f4f7f6; }
        body { background-color: var(--light); font-family: 'Segoe UI', sans-serif; }
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: white; }
        .login-card { width: 100%; max-width: 400px; padding: 40px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; }
        .btn-login { background: linear-gradient(to right, #ff9800, #f57c00); border: none; color: white; border-radius: 30px; padding: 12px; font-weight: bold; width: 100%; }
        .header-banner { background: linear-gradient(135deg, var(--teal), #4db6ac); color: white; padding: 50px 20px; border-radius: 0 0 40px 40px; text-align: center; }
        .card-menu { background: white; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; height: 100%; transition: 0.3s; }
        .card-menu:hover { transform: translateY(-5px); }
        .step-card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; border-left: 6px solid var(--orange); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .pes-box { background: linear-gradient(135deg, #ffffff, #f1f8e9); border-radius: 20px; padding: 25px; border-left: 10px solid #2e7d32; margin-top: 15px; text-align: left; }
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-success mb-3"></div>
    <p class="fw-bold">Sedang Memproses Data...</p>
</div>

<div id="pageLogin" class="login-page">
    <div class="login-card">
        <img src="logo_NCPDA.png" style="width:200px" class="mb-4" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2830/2830305.png'">
        <div class="text-start">
            <label class="small fw-bold ms-2">Username</label>
            <input type="text" id="userInput" class="form-control mb-3 rounded-pill px-4 shadow-sm" placeholder="Masukkan username">
            <label class="small fw-bold ms-2">Password</label>
            <input type="password" id="passInput" class="form-control mb-4 rounded-pill px-4 shadow-sm" placeholder="Masukkan password">
            <button onclick="handleLogin()" class="btn btn-login shadow">LOG IN</button>
        </div>
    </div>
</div>

<div id="pageDashboard" style="display:none;">
    <div class="header-banner">
        <h2 id="txtWelcome" class="fw-bold">Halo!</h2>
        <p>Expert System Asuhan Gizi Terstandar</p>
        <button onclick="handleLogout()" class="btn btn-sm btn-outline-light rounded-pill px-3 no-print">Logout</button>
    </div>
    <div class="container mt-n4 no-print">
        <div class="row g-3 px-3">
            <div class="col-6">
                <div class="card-menu" onclick="showSection('sectionForm')">
                    <i class="bi bi-clipboard2-pulse fs-1 text-success"></i><br>
                    <span class="fw-bold small">Assessment</span>
                </div>
            </div>
            <div class="col-6">
                <div class="card-menu">
                    <i class="bi bi-people fs-1 text-warning"></i><br>
                    <span class="fw-bold small">Data Pasien</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="sectionForm" class="container py-4" style="display:none;">
    <div class="no-print d-flex align-items-center mb-4" onclick="showSection('pageDashboard')" style="cursor:pointer">
        <i class="bi bi-arrow-left-circle-fill fs-2 me-2 text-teal"></i>
        <h4 class="mb-0 fw-bold text-teal">Nutrition Assessment</h4>
    </div>

    <div id="inputArea" class="no-print">
        <div class="step-card">
            <h6 class="fw-bold text-teal mb-3">A. Antropometri</h6>
            <input type="text" id="pName" class="form-control mb-3" placeholder="Nama Lengkap Pasien">
            <div class="row g-2">
                <div class="col-6"><input type="number" id="pBB" class="form-control" placeholder="BB (kg)"></div>
                <div class="col-6"><input type="number" id="pTB" class="form-control" placeholder="TB (cm)"></div>
            </div>
        </div>

        <div class="step-card">
            <h6 class="fw-bold text-teal mb-3">B & C. Biokimia & Dietary</h6>
            <div class="input-group mb-3">
                <select id="pLabType" class="form-select w-25"><option value="GDS">GDS</option><option value="Hb">Hb</option></select>
                <input type="number" id="pLabVal" class="form-control w-75" placeholder="Nilai Laboratorium">
            </div>
            <label class="small fw-bold mb-2">Asupan Energi (%)</label>
            <input type="range" id="pAsupan" class="form-range" min="0" max="150" value="100" oninput="this.nextElementSibling.value = this.value">
            <output class="fw-bold text-success">100</output><span class="text-success fw-bold">%</span>
        </div>

        <div class="step-card">
            <h6 class="fw-bold text-teal mb-3">D. Fisik & Klinis</h6>
            <div id="listFisik" class="row px-2">
                <p class="small text-muted">Memuat data gejala...</p>
            </div>
        </div>

        <button onclick="runExpert()" class="btn btn-success w-100 py-3 rounded-pill fw-bold shadow mb-5">GENERASI DIAGNOSA (PES)</button>
    </div>

    <div id="resultArea" style="display:none;">
        <div class="no-print d-flex justify-content-between mb-3 mt-4">
            <h5 class="fw-bold text-success">Hasil Diagnosis Gizi:</h5>
            <button onclick="window.print()" class="btn btn-primary btn-sm rounded-pill px-4 shadow">Cetak</button>
        </div>
        <div class="card border-0 shadow p-4 rounded-4 mb-5 text-center">
            <img src="logo_NCPDA.png" width="80" class="mx-auto mb-2">
            <h4 class="fw-bold mb-0">NUTRITION CARE PROCESS REPORT</h4>
            <p id="resPatientName" class="text-uppercase fw-bold text-teal mt-2"></p>
            <hr>
            <div id="pesOutput"></div>
        </div>
    </div>
</div>

<script>
    // GANTI URL INI DENGAN URL /exec BARU ANDA
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-_Mmbmu4Jh62Nq21SKlaF1HbUXLHaqXnXXLAluu_8a2XGFFpYYserKcESnSEB78s/exec"; 

    let masterData = null;

    window.onload = async () => {
        const saved = sessionStorage.getItem('ncp_user');
        if (saved) {
            const user = JSON.parse(saved);
            document.getElementById('pageLogin').style.display = "none";
            document.getElementById('pageDashboard').style.display = "block";
            document.getElementById('txtWelcome').innerText = `Halo, ${user.name}!`;
            await loadMasterData();
        }
    };

    // Fungsi muat data checkbox dari sheet logika_fisik_klinis
    async function loadMasterData() {
        try {
            masterData = await fetch(SCRIPT_URL).then(r => r.json());
            let htmlFisik = "";
            masterData.logika_fisik_klinis.forEach((item, index) => {
                htmlFisik += `
                    <div class="form-check col-6 mb-2">
                        <input class="form-check-input check-fisik" type="checkbox" value="${item.gejala}" id="f${index}">
                        <label class="form-check-label small" for="f${index}">${item.gejala}</label>
                    </div>`;
            });
            document.getElementById('listFisik').innerHTML = htmlFisik;
        } catch(e) { console.error("Gagal muat data pilar D"); }
    }

    function showSection(id) {
        document.getElementById('pageDashboard').style.display = (id==='pageDashboard'?'block':'none');
        document.getElementById('sectionForm').style.display = (id==='sectionForm'?'block':'none');
    }

    async function handleLogin() {
        const u = document.getElementById('userInput').value;
        const p = document.getElementById('passInput').value;
        if(!u || !p) return alert("Username & Password wajib diisi!");
        toggleLoader(true);
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`).then(r => r.json());
            if(res.status === "success") {
                sessionStorage.setItem('ncp_user', JSON.stringify(res.data));
                location.reload();
            } else { alert(res.message); }
        } catch(e) { alert("Cek koneksi internet atau URL Script!"); }
        toggleLoader(false);
    }

    async function runExpert() {
        const name = document.getElementById('pName').value;
        if(!name) return alert("Nama pasien wajib diisi!");
        toggleLoader(true);
        
        try {
            const bb = parseFloat(document.getElementById('pBB').value) || 0;
            const tb = (parseFloat(document.getElementById('pTB').value) || 0) / 100;
            const imt = tb > 0 ? bb / (tb * tb) : 0;
            const labType = document.getElementById('pLabType').value;
            const labVal = parseFloat(document.getElementById('pLabVal').value) || 0;
            const asup = parseFloat(document.getElementById('pAsupan').value);
            const terpilihFisik = Array.from(document.querySelectorAll('.check-fisik:checked')).map(c => c.value);

            let codes = [];

            // A. Antropometri
            masterData.logika_antropometri.forEach(l => {
                if(l.kategori === "Underweight" && imt < 18.5 && imt > 0) codes.push(l.kode_diagnosa);
                if(l.kategori === "Overweight" && imt > 25) codes.push(l.kode_diagnosa);
            });

            // B. Biokimia
            masterData.logika_biokimia.forEach(l => {
                if(l.jenis_lab === labType && labType === "GDS" && labVal > 200) codes.push(l.kode_diagnosa);
            });

            // C. Dietary
            masterData.logika_dietary.forEach(l => {
                if(l.kondisi === "Defisit" && asup < 80) codes.push(l.kode_diagnosa);
            });

            // D. Fisik Klinis
            terpilihFisik.forEach(g => {
                const match = masterData.logika_fisik_klinis.find(item => item.gejala === g);
                if(match) codes.push(match.kode_diagnosa);
            });

            // Render Hasil PES
            let htmlResults = "";
            [...new Set(codes)].forEach(k => {
                const item = masterData.master_diagnosa_pes.find(m => m.Kode === k);
                if(item) {
                    htmlResults += `
                        <div class="pes-box shadow-sm mb-3">
                            <span class="badge bg-warning text-dark mb-2">${item.Kode}</span>
                            <h5 class="fw-bold text-success">${item['Problem (P)']}</h5>
                            <p class="small mb-1"><strong>Etiologi (E):</strong> ${item['Etiologi (E)']}</p>
                            <p class="small mb-0"><strong>Signs & Symptoms (S):</strong> ${item['Signs_Symptoms (S)']}</p>
                        </div>`;
                }
            });

            document.getElementById('resPatientName').innerText = "Pasien: " + name;
            document.getElementById('pesOutput').innerHTML = htmlResults || "<div class='alert alert-info'>Tidak ditemukan masalah spesifik.</div>";
            document.getElementById('resultArea').style.display = "block";
            window.scrollTo(0, document.body.scrollHeight);
        } catch(e) { alert("Gagal memproses diagnosa."); }
        toggleLoader(false);
    }

    function handleLogout() { sessionStorage.clear(); location.reload(); }
    function toggleLoader(s) { document.getElementById('loader').style.display = s?'flex':'none'; }
</script>
</body>
</html>
