<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCP of DA - Expert System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --teal-dark: #00695c; --teal-light: #00897b; --orange: #ff9800; --bg-soft: #f8fbfb; }
        body { background: var(--bg-soft); font-family: 'Inter', sans-serif; color: #444; overflow-x: hidden; }
        
        /* LOGIN REDESIGN - RESPONSIVE */
        .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 15px; }
        .login-card { max-width: 950px; width: 100%; background: white; border-radius: 30px; overflow: hidden; display: flex; flex-wrap: wrap; box-shadow: 0 20px 60px rgba(0,0,0,0.06); }
        .login-left { background: #ffffff; padding: 40px; flex: 1; min-width: 300px; border-right: 1px solid #f0f0f0; display: flex; flex-direction: column; justify-content: center; }
        .login-right { background: #fafdfc; padding: 40px; flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .brand-title { font-size: clamp(2rem, 5vw, 3rem); font-weight: 800; color: var(--teal-dark); line-height: 1.1; }
        .brand-title span { color: var(--orange); }
        .app-logo-right { width: 90px; margin-bottom: 25px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        
        .input-custom { background: #f1f5f4 !important; border: none !important; border-radius: 15px !important; padding: 12px 20px !important; width: 100%; font-size: 0.95rem; }
        .btn-login { background: var(--orange); color: white; border: none; border-radius: 15px; padding: 12px; font-weight: 700; width: 100%; margin-top: 15px; transition: 0.3s; box-shadow: 0 8px 15px rgba(255,152,0,0.2); }

        /* WIZARD & CONTENT */
        .wizard-step { display: none; background: white; border-radius: 25px; padding: clamp(20px, 5vw, 40px); box-shadow: 0 10px 30px rgba(0,0,0,0.04); margin-bottom: 20px; }
        .section-title { font-weight: 800; color: var(--teal-dark); margin-bottom: 20px; border-left: 5px solid var(--orange); padding-left: 12px; font-size: 1.25rem; }
        
        /* CUSTOM NOTIF */
        #customAlert { display: none; position: fixed; top: 20px; right: 20px; left: 20px; z-index: 11000; padding: 15px; border-radius: 15px; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-left: 6px solid var(--orange); max-width: 400px; margin: auto; animation: slideIn 0.4s ease; }
        
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @media (max-width: 768px) { .login-left { text-align: center; align-items: center; border-right: none; border-bottom: 1px solid #f0f0f0; } }
        @media print { .no-print { display: none !important; } .wizard-step { box-shadow: none; padding: 0; } }
    </style>
</head>
<body>

<div id="customAlert"><div class="d-flex align-items-center"><i class="bi bi-info-circle-fill text-warning fs-4 me-3"></i><div><p id="alertMsg" class="small mb-0 fw-bold"></p></div></div></div>

<div id="loader" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:10000; display:flex; justify-content:center; align-items:center; flex-direction:column;">
    <div class="spinner-border text-success mb-2"></div><span class="small fw-bold">Sinkronisasi...</span>
</div>

<div class="container py-3">
    <div id="navArea" class="mb-3 text-end no-print" style="display:none; max-width: 800px; margin: auto;">
        <span class="small text-muted me-2"><i class="bi bi-person-circle"></i> <strong id="userNameDisplay"></strong></span>
        <button onclick="doLogout()" class="btn btn-sm btn-outline-danger border-0 rounded-pill">Logout</button>
    </div>

    <div id="stepLogin" class="login-wrapper">
        <div class="login-card">
            <div class="login-left">
                <h1 class="brand-title">NCP <span>of DA</span></h1>
                <p class="text-muted small">Professional Nutrition Care Process System.</p>
                <div class="d-flex align-items-center mt-3 no-mobile-center">
                    <img src="FotoProfil.jpg" style="width:45px; height:45px; border-radius:50%; margin-right:12px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/45'">
                    <div class="text-start"><p class="mb-0 fw-bold small">Dian Agnesia</p><p class="text-muted mb-0" style="font-size:10px;">Expert System Dev</p></div>
                </div>
            </div>
            <div class="login-right">
                <img src="logo_NCPDA.png" class="app-logo-right" alt="Logo" onerror="this.style.display='none'">
                <input type="text" id="user" class="form-control input-custom mb-2" placeholder="Username">
                <input type="password" id="pass" class="form-control input-custom mb-3" placeholder="Password">
                <button onclick="doLogin()" class="btn-login">SIGN IN</button>
            </div>
        </div>
    </div>

    <div id="appBody" style="display:none; max-width: 800px; margin: auto;">
        
        <div id="stepPasien" class="wizard-step">
            <h4 class="section-title">Identitas</h4>
            <div class="input-group mb-4">
                <input type="text" id="inNIK" class="form-control bg-light border-0 rounded-start-4" placeholder="Input NIK">
                <button onclick="cekNIK()" class="btn btn-dark rounded-end-4 px-3">CARI</button>
            </div>
            <div class="row g-2">
                <div class="col-12"><input type="text" id="namaP" class="form-control input-custom" placeholder="Nama Pasien"></div>
                <div class="col-6"><label class="small text-muted">Tgl Lahir</label><input type="date" id="tglP" class="form-control input-custom"></div>
                <div class="col-6"><label class="small text-muted">Gender</label>
                    <select id="jkP" class="form-select input-custom">
                        <option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div class="col-12"><textarea id="diagP" class="form-control input-custom" placeholder="Diagnosa Medis" rows="2"></textarea></div>
            </div>
            <button onclick="show('stepAssess')" class="btn btn-dark w-100 mt-4 rounded-pill py-3 fw-bold">ASESMEN</button>
        </div>

        <div id="stepAssess" class="wizard-step">
            <h4 class="section-title">Nutrition Assessment</h4>
            <div class="row g-2">
                <div class="col-6"><label class="small fw-bold">BB (kg)</label><input type="number" id="inBB" class="form-control input-custom"></div>
                <div class="col-6"><label class="small fw-bold">TB (cm)</label><input type="number" id="inTB" class="form-control input-custom"></div>
                <div class="col-12 mt-2"><label class="small fw-bold">Asupan: <span id="valAsup">100</span>%</label>
                    <input type="range" id="inAsup" class="form-range" min="0" max="150" value="100" oninput="document.getElementById('valAsup').innerText=this.value">
                </div>
                <div class="col-12 mt-3"><label class="small fw-bold text-muted mb-2">Data Biokimia</label>
                    <div class="row row-cols-2 row-cols-md-3 g-2" id="labContainer"></div>
                </div>
                <div class="col-12 mt-3"><label class="small fw-bold text-muted mb-2">Fisik & Klinis</label>
                    <div id="listFisik" class="row row-cols-2 g-2"></div>
                </div>
            </div>
            <button onclick="prosesPES()" class="btn btn-success w-100 mt-4 rounded-pill py-3 fw-bold">GENERATE PES</button>
        </div>

        <div id="stepHasil" class="wizard-step">
            <div id="cetakArea">
                <center>
                    <img src="logo_NCPDA.png" style="width:60px;" onerror="this.style.display='none'">
                    <h5 class="fw-bold mt-2 mb-0">NUTRITION CARE REPORT</h5>
                    <p class="small text-muted mb-3">Expert System NCP of DA</p>
                </center>
                <div id="hasilPasien" class="p-3 bg-light rounded-4 small border mb-3"></div>
                <h6 class="fw-bold mb-2">DIAGNOSA GIZI (PES)</h6>
                <div id="hasilPES"></div>
                <div class="row mt-4 small">
                    <div class="col-6 text-muted">Dicetak: <br><strong id="waktuCetak"></strong></div>
                    <div class="col-6 text-end">Ahli Gizi,<br><br><br><strong id="namaAhliGizi"></strong></div>
                </div>
            </div>
            <button onclick="saveAndPrint()" class="btn btn-primary w-100 mt-4 rounded-pill py-3 no-print">SIMPAN PDF</button>
            <button onclick="location.reload()" class="btn btn-link w-100 mt-1 text-muted no-print text-decoration-none small">Input Baru</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyiAcMYSyf6kl30_5Cki9zBRnLZnD1wuBlyKVI0z4i7QV31B6wPDUd-XdGtDlDS9j8/exec"; 
    let DB = null, currentNutritionist = "", currentVisit = 1;

    // --- SESSION GUARD & INITIALIZATION ---
    window.onload = () => {
        const savedUser = localStorage.getItem('ncp_user');
        if (savedUser) {
            currentNutritionist = savedUser;
            initSession();
        }
    };

    async function initSession() {
        toggleLoad(true);
        try {
            DB = await fetch(SCRIPT_URL).then(r => r.json());
            renderInputs();
            document.getElementById('userNameDisplay').innerText = currentNutritionist;
            document.getElementById('stepLogin').style.display = "none";
            document.getElementById('navArea').style.display = "block";
            document.getElementById('appBody').style.display = "block";
            show('stepPasien');
        } catch(e) { notify("Gagal memuat database gizi."); }
        toggleLoad(false);
    }

    // --- CORE FUNCTIONS ---
    async function doLogin() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        if(!u || !p) return notify("Username & Password wajib diisi");
        toggleLoad(true);
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`).then(r => r.json());
            if(res.status === "success") {
                currentNutritionist = res.name;
                localStorage.setItem('ncp_user', res.name); // Simpan Sesi
                initSession();
            } else { notify("Login Gagal, cek akun Anda."); }
        } catch(e) { notify("Error Server."); }
        toggleLoad(false);
    }

    function doLogout() {
        localStorage.removeItem('ncp_user');
        location.reload();
    }

    async function cekNIK() {
        const nik = document.getElementById('inNIK').value;
        if(!nik) return;
        toggleLoad(true);
        try {
            const res = await fetch(`${SCRIPT_URL}?action=cekNIK&nik=${nik}`).then(r => r.json());
            if(res.status === "found") {
                document.getElementById('namaP').value = res.nama;
                document.getElementById('tglP').value = res.tglLahir;
                document.getElementById('jkP').value = res.jk;
                currentVisit = res.kunjunganKe;
                notify(`Data ditemukan. Kunjungan ke-${res.kunjunganKe}`);
            } else { currentVisit = 1; notify("NIK belum ada, mendaftarkan pasien baru."); }
        } catch(e) { notify("Error Cek NIK."); }
        toggleLoad(false);
    }

    function renderInputs() {
        let lb = ""; 
        const paramsUnik = [...new Set(DB.logika_biokimia.map(item => item.parameter))];
        paramsUnik.forEach(p => {
            lb += `<div class="col"><div class="p-2 border rounded bg-white" style="font-size:10px">
                   <label class="fw-bold d-block text-muted truncate">${p}</label>
                   <input type="number" class="form-control form-control-sm border-0 p-0 in-lab" data-param="${p}">
                   </div></div>`;
        });
        document.getElementById('labContainer').innerHTML = lb;
        
        let fs = ""; 
        DB.logika_fisik_klinis.forEach((item, i) => {
            fs += `<div class="col-6 small"><div class="form-check">
                   <input class="form-check-input chk-fisik" type="checkbox" value="${item.gejala}" id="f${i}">
                   <label class="form-check-label" for="f${i}" style="font-size:11px">${item.gejala}</label>
                   </div></div>`;
        });
        document.getElementById('listFisik').innerHTML = fs;
    }

    async function prosesPES() {
        const bb = parseFloat(document.getElementById('inBB').value), tb = parseFloat(document.getElementById('inTB').value)/100;
        if(!bb || !tb) return notify("BB/TB wajib diisi");
        
        const imt = bb / (tb * tb);
        const jk = document.getElementById('jkP').value;
        let codes = [], summaryBio = [], summaryFisik = [];

        document.querySelectorAll('.in-lab').forEach(input => {
            const val = parseFloat(input.value);
            if(!isNaN(val)) {
                summaryBio.push(`${input.dataset.param}:${val}`);
                DB.logika_biokimia.filter(r => r.parameter === input.dataset.param).forEach(rule => {
                    let th = parseFloat(rule.ambang_batas.replace(/[^\d.]/g, ''));
                    if(rule.ambang_batas.includes(">") && val > th) codes.push(rule.kode_diagnosa);
                    if(rule.ambang_batas.includes("<") && val < th) codes.push(rule.kode_diagnosa);
                });
            }
        });

        document.querySelectorAll('.chk-fisik:checked').forEach(c => {
            summaryFisik.push(c.value);
            codes.push(DB.logika_fisik_klinis.find(x => x.gejala === c.value).kode_diagnosa);
        });

        const finalCodes = [...new Set(codes)];
        toggleLoad(true);
        
        const params = new URLSearchParams({
            action: "simpanHistory", nik: document.getElementById('inNIK').value, 
            nama: document.getElementById('namaP').value, tgl: document.getElementById('tglP').value, 
            jk: jk, visit: currentVisit, diagMedis: document.getElementById('diagP').value,
            bb: bb, tb: document.getElementById('inTB').value, imt: imt.toFixed(1),
            asupan: document.getElementById('inAsup').value, biokimia: summaryBio.join(", "),
            fisik: summaryFisik.join(", "), pes: finalCodes.join(", "), ahli: currentNutritionist
        });

        try {
            await fetch(`${SCRIPT_URL}?${params.toString()}`);
            renderReport(imt, finalCodes, jk);
            notify("Data Berhasil Disimpan.");
        } catch(e) { notify("Gagal Simpan."); }
        toggleLoad(false);
    }

    function renderReport(imt, codes, jk) {
        document.getElementById('namaAhliGizi').innerText = currentNutritionist;
        document.getElementById('waktuCetak').innerText = new Date().toLocaleString('id-ID');
        document.getElementById('hasilPasien').innerHTML = `<b>NIK:</b> ${document.getElementById('inNIK').value} | <b>Nama:</b> ${document.getElementById('namaP').value}<br><b>JK:</b> ${jk} | <b>IMT:</b> ${imt.toFixed(1)}`;
        let h = "";
        codes.forEach(k => {
            const p = DB.master_diagnosa_pes.find(x => x.kode === k);
            if(p) h += `<div class="p-2 border-start border-3 border-success bg-white mb-2 small shadow-sm"><b>${p.kode}: ${p['problem (p)']}</b><p class="mb-0 x-small text-muted">E: ${p['etiologi (e)']} | S: ${p['signs_symptoms (s)']}</p></div>`;
        });
        document.getElementById('hasilPES').innerHTML = h || "Hasil Normal.";
        show('stepHasil');
    }

    function saveAndPrint() {
        const n = document.getElementById('namaP').value || "Pasien";
        document.title = "NCPofDA_" + n;
        window.print();
    }

    // --- UI HELPERS ---
    function notify(msg) {
        document.getElementById('alertMsg').innerText = msg;
        const box = document.getElementById('customAlert');
        box.style.display = 'block';
        setTimeout(() => { box.style.display = 'none'; }, 3500);
    }
    function show(id) { document.querySelectorAll('.wizard-step').forEach(s => s.style.display="none"); document.getElementById(id).style.display="block"; }
    function toggleLoad(s) { document.getElementById('loader').style.display=s?'flex':'none'; }
    
    // Warn before reload
    window.onbeforeunload = function() {
        if(document.getElementById('appBody').style.display === 'block') {
            return "Data sedang diinput, yakin ingin keluar?";
        }
    };
</script>
</body>
</html>
