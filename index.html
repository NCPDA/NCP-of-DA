<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCP of DA - Professional Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --main-teal: #00897b; --accent-orange: #ff9800; --soft-gray: #f8f9fa; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        
        /* Navigasi */
        .navbar-custom { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* Header Dashboard */
        .app-header { background: linear-gradient(135deg, #00897b, #4db6ac); color: white; padding: 40px 20px; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
        
        /* Card Assessment */
        .step-card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .step-card:hover { transform: translateY(-3px); }
        .section-icon { width: 40px; height: 40px; background: var(--soft-gray); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: var(--main-teal); }
        
        /* PES Result Display (Full Color) */
        .pes-box { background: linear-gradient(to right, #ffffff, #f1f8e9); border-radius: 15px; padding: 20px; border-left: 8px solid #43a047; box-shadow: 0 4px 12px rgba(67, 160, 71, 0.15); margin-bottom: 15px; }
        .pes-badge { background: #ff9800; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .pes-box { border: 1px solid #ddd; box-shadow: none; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="spinner-grow text-success" role="status"></div>
</div>

<div id="loginPage" class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
    <div class="card p-4 border-0 shadow-lg text-center" style="max-width: 400px; width: 100%; border-radius: 25px;">
        <img src="https://i.ibb.co/LhqZ88D/logo-ncpda.png" width="100" class="mb-3 mx-auto">
        <h3 class="fw-bold" style="color:var(--main-teal)">NCP <span style="color:var(--accent-orange)">of</span> DA</h3>
        <p class="text-muted small mb-4">Silakan login untuk memulai asuhan gizi</p>
        <input type="text" id="user" class="form-control mb-3 py-2 shadow-sm" placeholder="Username">
        <input type="password" id="pass" class="form-control mb-4 py-2 shadow-sm" placeholder="Password">
        <button onclick="handleLogin()" class="btn btn-warning w-100 py-2 fw-bold text-white shadow-sm rounded-pill">LOG IN</button>
    </div>
</div>

<div id="mainDashboard" style="display:none;">
    <nav class="navbar navbar-custom no-print px-3 py-3 mb-0">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold" style="color:var(--main-teal)">NCP of DA</span>
            <button class="btn btn-outline-danger btn-sm rounded-pill" onclick="handleLogout()">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
            </button>
        </div>
    </nav>

    <div id="homeSection" class="no-print">
        <div class="app-header text-center">
            <h4 id="displayName" class="fw-bold">Selamat Datang!</h4>
            <p>Pilih menu untuk memulai layanan</p>
        </div>
        <div class="container mt-4 px-4">
            <div class="row g-3">
                <div class="col-6">
                    <div class="step-card text-center" onclick="showSection('assessmentSection')">
                        <i class="bi bi-person-plus fs-1 text-success"></i><br><span class="fw-bold small">Assessment Baru</span>
                    </div>
                </div>
                <div class="col-6">
                    <div class="step-card text-center">
                        <i class="bi bi-folder2 fs-1 text-warning"></i><br><span class="fw-bold small">Data Pasien</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="assessmentSection" class="container py-4 no-print" style="display:none;">
        <div class="d-flex align-items-center mb-4" onclick="showSection('homeSection')">
            <i class="bi bi-arrow-left fs-3 me-2"></i><h4 class="mb-0 fw-bold">Input Data Pasien</h4>
        </div>

        <div class="step-card">
            <div class="d-flex align-items-center mb-3">
                <div class="section-icon"><i class="bi bi-person-vcard fs-5"></i></div>
                <h6 class="mb-0 fw-bold">Identitas Dasar</h6>
            </div>
            <input type="text" id="patientName" class="form-control mb-3" placeholder="Nama Lengkap Pasien">
            <div class="row g-2">
                <div class="col-6"><input type="number" id="bb" class="form-control" placeholder="BB (kg)"></div>
                <div class="col-6"><input type="number" id="tb" class="form-control" placeholder="TB (cm)"></div>
            </div>
        </div>

        <div class="step-card">
            <div class="d-flex align-items-center mb-3">
                <div class="section-icon"><i class="bi bi-activity fs-5"></i></div>
                <h6 class="mb-0 fw-bold">Biokimia & Dietary</h6>
            </div>
            <div class="input-group mb-3">
                <select id="labType" class="form-select w-25">
                    <option value="GDS">GDS</option>
                    <option value="Hb">Hb</option>
                </select>
                <input type="number" id="labVal" class="form-control w-75" placeholder="Hasil Nilai Lab">
            </div>
            <label class="small text-muted mb-2 d-block">Asupan Energi (%)</label>
            <input type="range" id="asupan" class="form-range" min="0" max="150" value="100">
        </div>

        <button id="btnProses" onclick="runAnalysis()" class="btn btn-success w-100 py-3 rounded-pill fw-bold shadow">PROSES DIAGNOSA</button>
    </div>

    <div id="resultSection" class="container py-4" style="display:none;">
        <div class="no-print d-flex justify-content-between mb-4">
            <button class="btn btn-light" onclick="showSection('assessmentSection')"><i class="bi bi-pencil me-1"></i> Edit Data</button>
            <button class="btn btn-primary" onclick="window.print()"><i class="bi bi-printer me-1"></i> Cetak Diagnosa</button>
        </div>

        <div class="card p-4 border-0 shadow rounded-4">
            <div class="text-center mb-4">
                <img src="https://i.ibb.co/LhqZ88D/logo-ncpda.png" width="60">
                <h4 class="fw-bold mt-2">Nutrition Care Process Report</h4>
                <p id="printPatient" class="text-uppercase fw-bold text-success border-bottom pb-2"></p>
            </div>

            <h6 class="fw-bold text-muted mb-3">KESIMPULAN DIAGNOSA GIZI (PES):</h6>
            <div id="pesContent"></div>
            
            <div class="mt-5 text-end pe-4 print-only" style="display:none;">
                <p class="small mb-5">Ahli Gizi Pemeriksa,</p>
                <p class="fw-bold" id="signerName"></p>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx5fTBiHtEzfsRTp9zeMpzHOApbhCCESWjOKTPkhw7nif4bXY8-Oev7eemv64XvzgY/exec"; // Masukkan URL Web App Anda

    // Cek Session Saat Refresh
    window.onload = () => {
        const loggedUser = sessionStorage.getItem('ncpUser');
        if(loggedUser) {
            const data = JSON.parse(loggedUser);
            showDashboard(data);
        }
    };

    function showSection(id) {
        document.getElementById('homeSection').style.display = (id === 'homeSection') ? 'block' : 'none';
        document.getElementById('assessmentSection').style.display = (id === 'assessmentSection') ? 'block' : 'none';
        document.getElementById('resultSection').style.display = (id === 'resultSection') ? 'block' : 'none';
    }

    function handleLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        if(!u || !p) return alert("Isi username & password");

        toggleLoader(true);
        fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`)
        .then(res => res.json())
        .then(res => {
            toggleLoader(false);
            if(res.status === "success") {
                sessionStorage.setItem('ncpUser', JSON.stringify(res.data));
                showDashboard(res.data);
            } else { alert(res.message); }
        })
        .catch(() => { toggleLoader(false); alert("Error Server!"); });
    }

    function handleLogout() {
        sessionStorage.clear();
        location.reload();
    }

    function showDashboard(userData) {
        document.getElementById('loginPage').style.display = "none";
        document.getElementById('mainDashboard').style.display = "block";
        document.getElementById('displayName').innerText = `Halo, ${userData.name}!`;
        document.getElementById('signerName').innerText = userData.name;
    }

    async function runAnalysis() {
        const name = document.getElementById('patientName').value;
        if(!name) return alert("Nama pasien wajib diisi!");

        toggleLoader(true);
        try {
            const bb = parseFloat(document.getElementById('bb').value);
            const tb = parseFloat(document.getElementById('tb').value) / 100;
            const imt = bb / (tb * tb);
            const labType = document.getElementById('labType').value;
            const labVal = parseFloat(document.getElementById('labVal').value);
            const asup = parseFloat(document.getElementById('asupan').value);

            const db = await fetch(SCRIPT_URL).then(r => r.json());
            let codes = [];

            // Logika Penentuan Kode
            if(imt < 18.5) codes.push("NC-3.1");
            else if(imt > 25) codes.push("NC-3.3");
            if(labType === "GDS" && labVal > 200) codes.push("NC-2.2");
            if(asup < 80) codes.push("NI-1.2");

            let html = "";
            [...new Set(codes)].forEach(k => {
                const item = db.master_diagnosa_pes.find(m => m.Kode === k);
                if(item) {
                    html += `
                        <div class="pes-box shadow-sm mb-3">
                            <span class="pes-badge mb-2 d-inline-block">${item.Kode}</span>
                            <div class="mb-1"><strong>Problem:</strong> ${item['Problem (P)']}</div>
                            <div class="small text-muted mb-1"><strong>Etiology:</strong> ${item['Etiologi (E)']}</div>
                            <div class="small text-muted"><strong>Signs/Symptoms:</strong> ${item['Signs_Symptoms (S)']}</div>
                        </div>`;
                }
            });

            document.getElementById('printPatient').innerText = `PASIEN: ${name}`;
            document.getElementById('pesContent').innerHTML = html || "Hasil Assessment: Status Gizi Normal.";
            showSection('resultSection');
        } catch (e) {
            alert("Gagal memproses data.");
        } finally {
            toggleLoader(false);
        }
    }

    function toggleLoader(show) {
        document.getElementById('loader').style.display = show ? "flex" : "none";
    }
</script>
</body>
</html>
