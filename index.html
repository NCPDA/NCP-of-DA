<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCP of DA - Professional Expert System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --teal-dark: #00695c; --teal-light: #00897b; --orange: #ff9800; --bg-soft: #f8fbfb; }
        body { background: var(--bg-soft); font-family: 'Inter', 'Segoe UI', sans-serif; color: #444; }
        
        /* LOGIN PAGE */
        .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { 
            max-width: 950px; width: 100%; background: white; border-radius: 40px; overflow: hidden; 
            display: flex; box-shadow: 0 20px 60px rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.03);
        }
        .login-left { background: #ffffff; padding: 70px; flex: 1.3; border-right: 1px solid #f0f0f0; }
        .login-right { background: #fafdfc; padding: 70px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        .profile-box { display: flex; align-items: center; margin-bottom: 40px; }
        .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #8bc34a; object-fit: cover; margin-right: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .profile-info h5 { margin: 0; font-weight: 700; color: #333; }
        .profile-info p { margin: 0; font-size: 0.85rem; color: #888; }

        .brand-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 25px; letter-spacing: -1px; }
        .brand-title span { color: var(--orange); }
        .brand-title em { color: var(--teal-light); font-style: normal; }
        .brand-desc { font-size: 1rem; line-height: 1.8; color: #666; max-width: 450px; }

        .input-custom { background: #f1f5f4 !important; border: none !important; border-radius: 20px !important; padding: 15px 25px !important; font-size: 0.95rem; }
        .btn-login { background: var(--orange); color: white; border: none; border-radius: 20px; padding: 15px; font-weight: 700; width: 100%; margin-top: 20px; transition: 0.3s; box-shadow: 0 10px 20px rgba(255,152,0,0.2); }
        .btn-login:hover { transform: translateY(-2px); }

        /* WIZARD STEPS */
        .wizard-step { display: none; background: white; border-radius: 30px; padding: 40px; box-shadow: 0 15px 40px rgba(0,0,0,0.04); margin-bottom: 30px; }
        .active { display: block; animation: fadeIn 0.5s ease; }
        
        .section-title { font-weight: 800; color: var(--teal-dark); margin-bottom: 25px; position: relative; padding-left: 15px; }
        .section-title::before { content: ''; position: absolute; left: 0; top: 5px; height: 25px; width: 5px; background: var(--orange); border-radius: 10px; }
        
        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }

        @media (max-width: 992px) { .login-card { flex-direction: column; } .login-left, .login-right { padding: 40px; } }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-success mb-3" style="width: 3rem; height: 3rem;"></div>
    <span class="fw-bold text-teal-dark">Memproses Data...</span>
</div>

<div class="container">
    <div id="navArea" class="mt-4 mb-2 text-end no-print" style="display:none; max-width: 800px; margin: auto;">
        <span class="me-3 small text-muted">Petugas: <strong id="userName"></strong></span>
        <button onclick="location.reload()" class="btn btn-sm btn-outline-danger rounded-pill px-3">Logout</button>
    </div>

    <div id="stepLogin" class="login-wrapper">
        <div class="login-card">
            <div class="login-left">
                <div class="profile-box">
                    <img src="FotoProfil.jpg" class="profile-img" alt="Dian Agnesia" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="profile-info">
                        <h5>Dian Agnesia</h5>
                        <p>Lecturer of Nutrition</p>
                    </div>
                </div>
                <h1 class="brand-title"><em>NCP</em> <span>of DA</span></h1>
                <p class="brand-desc">Platform digital inovatif untuk mempermudah implementasi <strong>Nutrition Care Process</strong> secara terstruktur dan efisien.</p>
            </div>
            <div class="login-right text-center">
                <div class="text-start w-100">
                    <h5 class="fw-bold mb-4">Akses Sistem</h5>
                    <input type="text" id="user" class="form-control input-custom mb-3" placeholder="Username">
                    <input type="password" id="pass" class="form-control input-custom mb-4" placeholder="Password">
                    <button onclick="doLogin()" class="btn-login shadow">SIGN IN</button>
                </div>
            </div>
        </div>
    </div>

    <div style="max-width: 800px; margin: auto;">
        <div id="stepPasien" class="wizard-step">
            <h4 class="section-title">Identitas Pasien</h4>
            <div class="row g-3">
                <div class="col-12">
                    <input type="text" id="namaP" class="form-control form-control-lg mb-2 rounded-4 bg-light border-0" placeholder="Nama Lengkap Pasien">
                </div>
                <div class="col-6">
                    <label class="small text-muted mb-1">Tanggal Lahir</label>
                    <input type="date" id="tglP" class="form-control bg-light border-0 py-2">
                </div>
                <div class="col-6">
                    <label class="small text-muted mb-1">Jenis Kelamin</label>
                    <select id="jkP" class="form-select bg-light border-0 py-2">
                        <option>Laki-laki</option>
                        <option>Perempuan</option>
                    </select>
                </div>
                <div class="col-12">
                    <textarea id="diagP" class="form-control bg-light border-0" placeholder="Diagnosa Medis / Alasan Masuk" rows="2"></textarea>
                </div>
            </div>
            <button onclick="show('stepAssess')" class="btn btn-dark w-100 mt-5 rounded-pill py-3 fw-bold">LANJUT KE ASESMEN</button>
        </div>

        <div id="stepAssess" class="wizard-step">
            <h4 class="section-title">Nutrition Assessment</h4>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="p-3 border rounded-4 bg-light">
                        <label class="small fw-bold text-muted mb-2">ANTROPOMETRI</label>
                        <div class="row g-2">
                            <div class="col-6"><input type="number" id="inBB" class="form-control border-0" placeholder="BB (kg)"></div>
                            <div class="col-6"><input type="number" id="inTB" class="form-control border-0" placeholder="TB (cm)"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 border rounded-4 bg-light">
                        <label class="small fw-bold">ASUPAN ENERGI: <span id="valAsup" class="text-success">100</span>%</label>
                        <input type="range" id="inAsup" class="form-range mt-2" min="0" max="150" value="100" oninput="document.getElementById('valAsup').innerText=this.value">
                    </div>
                </div>
                <div class="col-12">
                    <label class="small fw-bold text-muted text-uppercase mb-2">Data Biokimia (Laboratorium)</label>
                    <div class="row row-cols-2 row-cols-md-4 g-2" id="labContainer"></div>
                </div>
                <div class="col-12 mt-2">
                    <label class="small fw-bold text-muted text-uppercase mb-2">Fisik & Klinis</label>
                    <div id="listFisik" class="row row-cols-2 g-1"></div>
                </div>
            </div>
            <button onclick="prosesPES()" class="btn btn-success w-100 mt-5 rounded-pill py-3 fw-bold shadow">GENERATE PES & SIMPAN</button>
        </div>

        <div id="stepHasil" class="wizard-step">
            <div id="cetakArea">
                <center>
                    <h5 class="fw-bold mb-1">NUTRITION CARE REPORT</h5>
                    <p class="small text-muted mb-3" id="pVisitLabel">Kunjungan Pertama</p>
                </center>
                <hr>
                <div id="hasilPasien" class="mb-4 p-3 bg-light rounded-4 small border"></div>
                <h6 class="fw-bold mt-4 mb-3"><i class="bi bi-activity text-success me-2"></i>Diagnosa Gizi (PES)</h6>
                <div id="hasilPES"></div>
                <div class="row mt-5 small">
                    <div class="col-7 text-muted italic">Dicetak pada: <br><strong id="waktuCetak"></strong></div>
                    <div class="col-5 text-end">Ahli Gizi Pemeriksa,<br><br><br><strong id="namaAhliGizi"></strong></div>
                </div>
            </div>
            <button onclick="saveAndPrint()" class="btn btn-primary w-100 mt-4 rounded-pill py-2 shadow-sm no-print">
                <i class="bi bi-printer me-2"></i>CETAK PDF
            </button>
            <button onclick="location.reload()" class="btn btn-link w-100 mt-2 text-muted no-print text-decoration-none small">Input Pasien Baru</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzh6oSMf_OIU6EMF554WI_ZG7buNTkFNoH0D-dNwwrezi6GyLhWUlaoIlvm9A0lBuM/exec"; 
    let DB = null, currentNutritionist = "", visitCount = 1;

    function toggleLoad(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    function show(id) { 
        document.querySelectorAll('.wizard-step').forEach(s => s.style.display = "none"); 
        document.getElementById(id).style.display = "block"; 
        window.scrollTo(0,0);
    }

    async function doLogin() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        if(!u || !p) return alert("Username & Password wajib diisi!");
        
        toggleLoad(true);
        try {
            const res = await fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`).then(r => r.json());
            if(res.status === "success") {
                currentNutritionist = res.name;
                // Ambil Database Master setelah login berhasil
                DB = await fetch(SCRIPT_URL).then(r => r.json());
                renderInputs();
                document.getElementById('userName').innerText = res.name;
                document.getElementById('navArea').style.display = "block";
                document.getElementById('stepLogin').style.display = "none";
                show('stepPasien');
            } else { alert("Maaf, Username atau Password salah."); }
        } catch(e) { alert("Gagal terhubung ke Database Cloud."); }
        toggleLoad(false);
    }

    function renderInputs() {
        // Render Input Lab
        let labH = "";
        DB.logika_biokimia.forEach(item => {
            labH += `<div class="col"><div class="p-2 border rounded bg-white"><label style="font-size:9px" class="fw-bold d-block text-muted text-uppercase">${item.parameter}</label><input type="number" class="form-control form-control-sm border-0 p-0 in-lab" data-param="${item.parameter}"></div></div>`;
        });
        document.getElementById('labContainer').innerHTML = labH;

        // Render Checkbox Fisik
        let fisH = "";
        DB.logika_fisik_klinis.forEach((item, i) => {
            fisH += `<div class="col small"><div class="form-check"><input class="form-check-input chk-fisik" type="checkbox" value="${item.gejala}" id="f${i}"><label class="form-check-label" for="f${i}">${item.gejala}</label></div></div>`;
        });
        document.getElementById('listFisik').innerHTML = fisH;
    }

    async function prosesPES() {
        const bb = parseFloat(document.getElementById('inBB').value), tb = parseFloat(document.getElementById('inTB').value)/100;
        if(!bb || !tb) return alert("Lengkapi data BB & TB untuk kalkulasi IMT.");
        
        const imt = bb / (tb * tb);
        const asup = parseFloat(document.getElementById('inAsup').value);
        let codes = [];

        // 1. Logika IMT Sederhana
        if(imt < 18.5) codes.push("NC-3.1"); 
        else if(imt > 25) codes.push("NC-3.3");

        // 2. Logika Biokimia
        document.querySelectorAll('.in-lab').forEach(input => {
            const val = parseFloat(input.value);
            if(!isNaN(val)) {
                const rules = DB.logika_biokimia.filter(r => r.parameter === input.dataset.param);
                rules.forEach(rule => {
                    let th = parseFloat(rule.ambang_batas.replace(/[^\d.]/g, ''));
                    if(rule.ambang_batas.includes(">") && val > th) codes.push(rule.kode_diagnosa);
                    if(rule.ambang_batas.includes("<") && val < th) codes.push(rule.kode_diagnosa);
                });
            }
        });

        // 3. Logika Fisik (Checkbox)
        document.querySelectorAll('.chk-fisik:checked').forEach(c => {
            const f = DB.logika_fisik_klinis.find(x => x.gejala === c.value);
            if(f) codes.push(f.kode_diagnosa);
        });

        const uniqueCodes = [...new Set(codes)];
        
        toggleLoad(true);
        await saveHistoryData(imt, uniqueCodes.join(", "));
        renderReport(imt, uniqueCodes);
        toggleLoad(false);
    }

    async function saveHistoryData(imt, pesString) {
        const params = new URLSearchParams({
            action: "simpanHistory",
            nama: document.getElementById('namaP').value,
            visit: visitCount,
            diagMedis: document.getElementById('diagP').value,
            bb: document.getElementById('inBB').value,
            tb: document.getElementById('inTB').value,
            imt: imt.toFixed(1),
            asupan: document.getElementById('inAsup').value,
            biokimia: "", // Opsional: Tambahkan detail jika perlu
            fisik: "", 
            pes: pesString,
            ahli: currentNutritionist
        });

        try {
            await fetch(`${SCRIPT_URL}?${params.toString()}`);
        } catch(e) { console.error("Koneksi gagal saat menyimpan history."); }
    }

    function renderReport(imt, codes) {
        document.getElementById('namaAhliGizi').innerText = currentNutritionist;
        document.getElementById('waktuCetak').innerText = new Date().toLocaleString('id-ID', {day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'}) + " WIB";
        document.getElementById('hasilPasien').innerHTML = `
            <div class="row">
                <div class="col-6"><b>Nama:</b> ${document.getElementById('namaP').value}</div>
                <div class="col-6"><b>IMT:</b> ${imt.toFixed(1)} kg/mÂ²</div>
                <div class="col-12 mt-1"><b>Diagnosa Medis:</b> ${document.getElementById('diagP').value || '-'}</div>
            </div>`;
        
        let h = "";
        if (codes.length > 0) {
            codes.forEach(k => {
                const p = DB.master_diagnosa_pes.find(x => x.kode === k);
                if(p) h += `<div class="p-3 border-start border-4 border-success bg-light mb-2 small shadow-sm rounded-end">
                    <b>${p.kode}: ${p['problem (p)']}</b>
                    <p class="mb-0 mt-1">E: ${p['etiologi (e)']} | S: ${p['signs_symptoms (s)']}</p>
                </div>`;
            });
        } else { h = "<div class='p-3 text-center italic text-muted border rounded-4'>Hasil Asesmen Normal (Tidak ditemukan masalah gizi).</div>"; }
        
        document.getElementById('hasilPES').innerHTML = h;
        show('stepHasil');
    }

    function saveAndPrint() {
        const n = document.getElementById('namaP').value || "Pasien";
        document.title = "NCPofDA_" + n;
        window.print();
    }
</script>
</body>
</html>
