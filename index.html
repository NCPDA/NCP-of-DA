<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCP of DA - Professional Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --teal: #00897b; --orange: #ff9800; --bg: #f8f9fa; }
        body { background-color: var(--bg); font-family: 'Segoe UI', Tahoma, sans-serif; }
        
        /* Login Page */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #fff; }
        .login-card { width: 100%; max-width: 400px; padding: 40px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: none; }
        .btn-orange { background: linear-gradient(to right, #ff9800, #f57c00); border: none; color: white; border-radius: 25px; padding: 12px; font-weight: bold; width: 100%; }

        /* Dashboard & Header */
        .app-header { background: linear-gradient(135deg, #00897b, #4db6ac); color: white; padding: 40px 20px; border-radius: 0 0 35px 35px; margin-bottom: 25px; }
        .menu-card { background: white; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; border: none; height: 100%; }
        .menu-card:hover { transform: translateY(-5px); }

        /* Assessment Form */
        .step-card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; border-left: 6px solid var(--orange); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .section-title { font-weight: bold; color: var(--teal); margin-bottom: 15px; display: flex; align-items: center; }
        .section-title i { margin-right: 10px; font-size: 1.2rem; }

        /* PES Result - Professional Style */
        .pes-box { background: linear-gradient(to bottom right, #ffffff, #f1f8e9); border-radius: 20px; padding: 25px; border-left: 10px solid #2e7d32; box-shadow: 0 8px 25px rgba(0,0,0,0.1); margin-bottom: 20px; position: relative; overflow: hidden; }
        .pes-box::after { content: 'PES DIAGNOSIS'; position: absolute; top: 10px; right: -20px; background: rgba(0,0,0,0.05); transform: rotate(45deg); padding: 5px 30px; font-size: 0.7rem; font-weight: bold; }
        .pes-code { background: var(--orange); color: white; padding: 5px 15px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; display: inline-block; margin-bottom: 10px; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .pes-box { box-shadow: none; border: 1px solid #ddd; border-left: 10px solid #2e7d32; }
        }
    </style>
</head>
<body>

<div id="loader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column;">
    <div class="spinner-border text-success mb-2"></div>
    <p class="fw-bold">Sedang Memproses...</p>
</div>

<div id="pageLogin" class="login-container">
    <div class="login-card text-center">
        <img src="https://i.ibb.co/LhqZ88D/logo-ncpda.png" width="130" class="mb-3">
        <h2 class="fw-bold" style="color:var(--teal)">NCP <span style="color:var(--orange)">of</span> DA</h2>
        <p class="text-muted small mb-4">Nutrition Care Process Expert System</p>
        <div class="text-start">
            <label class="small fw-bold">Username</label>
            <input type="text" id="userInput" class="form-control mb-3 rounded-pill px-3" placeholder="Masukkan username">
            <label class="small fw-bold">Password</label>
            <input type="password" id="passInput" class="form-control mb-4 rounded-pill px-3" placeholder="Masukkan password">
            <button onclick="handleLogin()" class="btn-orange shadow">LOG IN</button>
        </div>
    </div>
</div>

<div id="pageDashboard" style="display:none;">
    <div class="app-header text-center">
        <img src="https://i.ibb.co/LhqZ88D/logo-ncpda.png" width="60" style="filter: brightness(0) invert(1);">
        <h3 id="txtWelcome" class="fw-bold mt-3">Halo, Dian Agnesia!</h3>
        <p>Akses Terpusat Asuhan Gizi Terstandar</p>
        <button onclick="handleLogout()" class="btn btn-sm btn-outline-light rounded-pill mt-2 no-print">Logout</button>
    </div>
    <div class="container mt-n5 no-print">
        <div class="row g-3 px-3">
            <div class="col-6">
                <div class="menu-card" onclick="openSection('sectionAssessment')">
                    <i class="bi bi-person-plus-fill fs-1 text-success"></i><br><span class="fw-bold">Assessment Baru</span>
                </div>
            </div>
            <div class="col-6">
                <div class="menu-card">
                    <i class="bi bi-folder-check fs-1 text-warning"></i><br><span class="fw-bold">Database Pasien</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="sectionAssessment" class="container py-4" style="display:none;">
    <div class="no-print d-flex align-items-center mb-4" onclick="openSection('pageDashboard')">
        <i class="bi bi-arrow-left-circle-fill fs-2 me-3 text-teal" style="cursor:pointer;"></i>
        <h4 class="mb-0 fw-bold">New Assessment (4 Pilar)</h4>
    </div>

    <div id="formInputArea" class="no-print">
        <div class="step-card">
            <div class="section-title"><i class="bi bi-person-vcard"></i> Identitas & Antropometri</div>
            <input type="text" id="pName" class="form-control mb-3" placeholder="Nama Lengkap Pasien">
            <div class="row g-2">
                <div class="col-6"><label class="small">BB (kg)</label><input type="number" id="pBB" class="form-control"></div>
                <div class="col-6"><label class="small">TB (cm)</label><input type="number" id="pTB" class="form-control"></div>
            </div>
        </div>

        <div class="step-card">
            <div class="section-title"><i class="bi bi-droplet"></i> Biokimia</div>
            <div class="row g-2">
                <div class="col-7">
                    <select id="pLabType" class="form-select">
                        <option value="GDS">GDS (Gula Darah)</option>
                        <option value="Hb">Hb (Hemoglobin)</option>
                        <option value="Albumin">Albumin</option>
                    </select>
                </div>
                <div class="col-5"><input type="number" id="pLabVal" class="form-control" placeholder="Nilai"></div>
            </div>
        </div>

        <div class="step-card">
            <div class="section-title"><i class="bi bi-basket"></i> Dietary (Asupan)</div>
            <label class="small">Persentase Asupan Energi Hari Ini</label>
            <div class="d-flex align-items-center">
                <input type="range" id="pAsupan" class="form-range me-3" min="0" max="150" value="100" oninput="this.nextElementSibling.value = this.value">
                <output class="fw-bold text-success">100</output><span class="fw-bold text-success">%</span>
            </div>
        </div>

        <div class="step-card">
            <div class="section-title"><i class="bi bi-heart-pulse"></i> Fisik & Klinis</div>
            <div class="row px-2">
                <div class="form-check col-6"><input class="form-check-input fisik" type="checkbox" value="Oedema" id="f1"><label class="form-check-label small" for="f1">Oedema</label></div>
                <div class="form-check col-6"><input class="form-check-input fisik" type="checkbox" value="Mual/Muntah" id="f2"><label class="form-check-label small" for="f2">Mual/Muntah</label></div>
                <div class="form-check col-6"><input class="form-check-input fisik" type="checkbox" value="Ascites" id="f3"><label class="form-check-label small" for="f3">Ascites</label></div>
                <div class="form-check col-6"><input class="form-check-input fisik" type="checkbox" value="Konjungtiva Pucat" id="f4"><label class="form-check-label small" for="f4">Mata Pucat</label></div>
            </div>
        </div>

        <button onclick="generateDiagnosis()" class="btn btn-success w-100 py-3 rounded-pill fw-bold shadow-lg mt-3 mb-5">ANALISIS DIAGNOSA GIZI (PES)</button>
    </div>

    <div id="resultArea" style="display:none;">
        <div class="no-print d-flex justify-content-between mb-4">
            <h5 class="fw-bold text-success">Laporan Diagnosis Gizi</h5>
            <button onclick="window.print()" class="btn btn-primary rounded-pill btn-sm"><i class="bi bi-printer me-2"></i>Cetak Laporan</button>
        </div>

        <div class="card border-0 shadow-sm p-4 rounded-4 mb-4">
            <div class="text-center mb-4">
                <img src="https://i.ibb.co/LhqZ88D/logo-ncpda.png" width="80">
                <h4 class="fw-bold mt-2">NUTRITION CARE PROCESS REPORT</h4>
                <div id="resPatientName" class="h5 text-uppercase fw-bold text-teal mt-2"></div>
                <hr>
            </div>
            
            <div id="pesContainer"></div>

            <div class="mt-5 text-end pe-4 print-only" style="display:none;">
                <p class="mb-5 small">Ahli Gizi Pemeriksa,</p>
                <p class="fw-bold" id="resSigner"></p>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz8C7a5ly_n4DMpmBOBBam-OD5l12g5U7SuTu7nWqOG1LRD6lPCPwdP7xNkjqJmscY/exec"; // GANTI DENGAN URL EXEC ANDA!

    // Session Management (Anti-Refresh)
    window.onload = () => {
        const session = sessionStorage.getItem('ncp_session');
        if(session) {
            const user = JSON.parse(session);
            document.getElementById('pageLogin').style.display = "none";
            document.getElementById('pageDashboard').style.display = "block";
            document.getElementById('txtWelcome').innerText = `Helio, ${user.name}!`;
            document.getElementById('resSigner').innerText = user.name;
        }
    };

    function openSection(id) {
        document.getElementById('pageDashboard').style.display = (id === 'pageDashboard') ? 'block' : 'none';
        document.getElementById('sectionAssessment').style.display = (id === 'sectionAssessment') ? 'block' : 'none';
    }

    async function handleLogin() {
        const u = document.getElementById('userInput').value;
        const p = document.getElementById('passInput').value;
        if(!u || !p) return alert("Username dan Password wajib diisi!");

        showLoader(true);
        try {
            const res = await fetch(`${API_URL}?action=login&user=${u}&pass=${p}`).then(r => r.json());
            if(res.status === "success") {
                sessionStorage.setItem('ncp_session', JSON.stringify(res.data));
                location.reload();
            } else { alert(res.message); }
        } catch (e) { alert("Server tidak merespons. Pastikan URL API benar."); }
        showLoader(false);
    }

    function handleLogout() {
        sessionStorage.clear();
        location.reload();
    }

    async function generateDiagnosis() {
        const pName = document.getElementById('pName').value;
        if(!pName) return alert("Nama pasien wajib diisi!");

        showLoader(true);
        try {
            // Ambil Input
            const bb = parseFloat(document.getElementById('pBB').value);
            const tb = parseFloat(document.getElementById('pTB').value) / 100;
            const imt = bb / (tb * tb);
            const labType = document.getElementById('pLabType').value;
            const labVal = parseFloat(document.getElementById('pLabVal').value);
            const asup = parseFloat(document.getElementById('pAsupan').value);
            const fisik = Array.from(document.querySelectorAll('.fisik:checked')).map(c => c.value);

            // Fetch Data dari Sheets
            const db = await fetch(API_URL).then(r => r.json());
            let diagnosaKodes = [];

            // 1. Logika Antropometri
            if(imt < 18.5) diagnosaKodes.push("NC-3.1");
            else if(imt > 25) diagnosaKodes.push("NC-3.3");

            // 2. Logika Biokimia
            if(labType === "GDS" && labVal > 200) diagnosaKodes.push("NC-2.2");
            else if(labType === "Hb" && labVal < 12) diagnosaKodes.push("NI-5.1");

            // 3. Logika Dietary
            if(asup < 80) diagnosaKodes.push("NI-1.2");

            // 4. Logika Fisik
            fisik.forEach(f => {
                const find = db.ref_fisik_klinis.find(r => r.Gejala === f);
                if(find) diagnosaKodes.push(find.Kode_Diagnosa);
            });

            // Render Hasil ke PES Box
            let finalHTML = "";
            [...new Set(diagnosaKodes)].forEach(kode => {
                const pes = db.master_diagnosa_pes.find(m => m.Kode === kode);
                if(pes) {
                    finalHTML += `
                        <div class="pes-box">
                            <span class="pes-code">${pes.Kode}</span>
                            <h5 class="fw-bold mb-3">${pes['Problem (P)']}</h5>
                            <p class="mb-2"><small class="fw-bold text-muted">ETIOLOGI (E):</small><br>${pes['Etiologi (E)']}</p>
                            <p class="mb-0"><small class="fw-bold text-muted">SIGNS/SYMPTOMS (S):</small><br>${pes['Signs_Symptoms (S)']}</p>
                        </div>`;
                }
            });

            document.getElementById('resPatientName').innerText = pName;
            document.getElementById('pesContainer').innerHTML = finalHTML || "<p class='text-center py-4'>Tidak ditemukan diagnosa gizi (Pasien Normal).</p>";
            document.getElementById('resultArea').style.display = "block";
            window.scrollTo(0, document.body.scrollHeight);

        } catch (e) {
            alert("Terjadi kesalahan saat sinkronisasi data.");
        }
        showLoader(false);
    }

    function showLoader(v) { document.getElementById('loader').style.display = v ? 'flex' : 'none'; }
</script>
</body>
</html>
